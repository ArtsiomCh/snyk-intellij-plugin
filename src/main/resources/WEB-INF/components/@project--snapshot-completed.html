<div class="project{{#unless project.isMonitored}} project--inactive{{/unless}}"{{#if_eq lastSnapshot.state 'pending'}} data-snyk-fetchsnapshot="{{project.publicId}}"{{/if_eq}}>
  <div class="project__source">
    <h3 class="project__target-file" data-snyk-test="project-target-file">
    {{#if_eq lastSnapshot.state 'complete'}}
      <a href="{{project.link}}" {{test-hook project.targetFile}}>
        <span class="project__target-type">{{svg (concat "icon/" project.type) height="20" width="20"}}</span>{{project.targetFile}}
      </a>
    {{else}}
      <span class="project__target-type">{{svg (concat "icon/" project.type) height="20" width="20"}}</span>{{project.targetFile}}
    {{/if_eq}}
    {{#if warning}}
      <span class="project__warning" {{test-hook project.name ' warning'}}>
        {{> @tooltip description=warning icon="warning"}}
      </span>
    {{/if}}
    </h3>
    {{#if tooltip}}
      {{> @tooltip}}
    {{/if}}
    {{#if alias}}
      <span class="project__alias" {{test-hook project.name ' alias'}}>
        {{alias}}
      </span>
    {{/if}}
  </div>

  <div class="project__info">
  {{#if project.isMonitored}}
    <div class="project__vulns">
      <div class="project__severity-list">
      {{#if_eq lastSnapshot.state 'pending'}}
        {{> @spinner--testing}}
      {{/if_eq}}
      {{#if_eq lastSnapshot.state 'failed'}}
        {{svg "icon/warning"}} <strong>Test failed.</strong>
        {{#> @form
          action=(concat "/org/" @root/org.name "/project/" project.publicId "/start")
          method="POST"
          form-modifier="form--inline"
        }}
        {{> @button
          type="submit"
          button="Retry"
          button-test-hook="project actions retry"
          modifiers="as-link"
        }}
        {{/ @form}}
        {{#if showProjectSettings}}
          or
          {{#> @form
            action=(concat "/org/" @root/org.name "/project/" project.publicId "/delete")
            method="POST"
            form-modifier="form--inline"
          }}
          {{> @button
            type="submit"
            button="delete this project"
            button-test-hook="project actions retry"
            modifiers="as-link"
          }}
          {{/ @form}}
        {{/if}}
      {{/if_eq}}
      {{#if_eq lastSnapshot.state 'complete'}}
        {{> @severity-list}}
      {{/if_eq}}
      </div>

      {{#if_eq lastSnapshot.state 'complete'}}
        <span><a href="{{project.link}}" class="project-card__action" {{test-hook (concat project.name '-link')}}>View report{{#if project.canFix}} and fix{{/if}}</a></span>
      {{/if_eq}}

      {{#unless project.isMonitored}}
        <button class="btn btn--xs" {{#unless project.Repo.isAdmin}}disabled title="No admin privileges for this repo."{{/unless}} onclick="activateProject('{{project.publicId}}','','{{project.orgName}}')">Add project</button>
        <span><a href="/" class="project-card__action">Ignore</a></span>
      {{/unless}}
    </div>

    {{#if lastSnapshot.monitor.hasNewVulns}}
      <span class="tag">New</span>
    {{/if}}
  {{/if}}
  </div>

  {{#if_eq lastSnapshot.state 'complete'}}
  <div class="project__actions">
    {{#if project.continuousTestingPaused}}
    <div class="project__actions__test">
      <span class="project-card__timestamp" {{test-hook (concat 'test-limit-end-date-' project.name)}}>Tests paused until {{fullDate @root.testLimitEndDate}}</span>
    </div>
    {{else if project.isMonitored}}
    <div class="project__actions__test">
      <div class="project__actions__test__frequency">
      {{#if (isAdmin @root/org.OrgMembership.role)}}
        {{#> @form
          form-test-hook=(concat "project set test frequency - " project.targetFile)
          action=(concat project.link "/settings/updateTestFrequency")
          method="POST"
          data="data-snyk-test-frequency"
        }}
          <div class="dropdown dropdown--xs">
            <label for="test-frequency-{{project.publicId}}" class="hidden">Test frequency</label>
            <select id="test-frequency-{{project.publicId}}" name="testFrequency">
              {{#each project.testFrequencyOptions}}
              <option label="{{title}}" {{#if value}}value="{{value}}"{{/if}} {{#if disabled}}disabled{{/if}} {{#if selected}}selected{{/if}}>{{title}}</option>
              {{/each}}
            </select>
          </div>
          {{!-- This partial is causing preview to fail, for some reason --}}
          {{> @button
            button="Save"
            type="submit"
            button-test-hook="submit"
            modifiers="xs"
            modifier="state--hidden"
            style="height:1.85em"
          }}
        {{/@form}}
      {{else}}
        Test {{project.testFrequency}}
      {{/if}}
      </div>
      <span class="project-card__timestamp">Tested {{relativeMoment lastSnapshot.created}}</span>
    </div>
    {{#if @root.showProjectSettings}}
    <a href="{{project.link}}/settings" class="project__settings" title="Project settings">
      {{svg "icon/settings" width="20" height="20"}}
    </a>
    {{/if}}
    {{else}}
      <div class="project__actions__test">
      <span class="project-card__timestamp">Tested {{relativeMoment lastSnapshot.created}}</span>
    </div>
    {{#if @root.showProjectActivateDeactivate}}
    <span><button class="btn btn--link project__actions__activate" onclick="activateProject('{{project.publicId}}','/projects?action=start&success=_SUCCESS_&result=_RESULT_','{{project.orgName}}')">Activate</button></span>
    {{/if}}
    {{/if}}
  </div>
  {{else}}
    {{#unless project.isMonitored}}
    <div class="project__actions">
      <div class="project__actions__test">
        <span class="project-card__timestamp">Tested {{relativeMoment lastSnapshot.created}}</span>
      </div>
      {{#if @root.showSettings}}
      <span><button class="btn btn--link project__actions__activate" onclick="activateProject('{{project.publicId}}','/projects?action=start&success=_SUCCESS_&result=_RESULT_','{{project.orgName}}')">Activate</button></span>
      {{/if}}
    </div>
    {{/unless}}
  {{/if_eq}}
</div>
